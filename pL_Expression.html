<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>

    <script type="text/javascript">

    //adding basic operators

    const topScope = Object.create(null);

    for(let op of ["+", "-", "*", "/", "%", "==", "<", ">"]){
      topScope[op] = Function("a, b", `return a ${op} b;`);
    }

    topScope.true = true;
    topScope.false = false;

    topScope.print = value => {
      console.log(value)
    };


    function skipSpace(string){
      let first = string.search(/\S/);
      if(first == -1) return "";
      return string.slice(first);
    }


    function parseExpression(program){
        program = skipSpace(program);

        let match, expr;
        if(match = /^"([^"]*)"/.exec(program)){
          expr = {type: "value", value: match[1]};
        }
        else if(match = /^\d+\b/.exec(program)){
          expr = {type: "value", value: (match[0]};
        }
        else if(match = /^[^\s(),"]+/.exec(program)){
          expr = {type: "word", name: match[0]};
        }
        else {
          throw new SyntaxError("Unexpected syntax: " + program);
        }

        return parseApply(expr, program.slice(match[0].length));
    }

    function parseApply(expr, program){
      program = skipSpace(program);
      if(program[0] != "("){
        return {expr: expr, rest: program};
      }

      program = skipSpace(program.slice(1));
      expr = {type: "apply", operator: expr, args: []};
      while(program[0] != ")"){
        let arg = parseExpression(program);
        expr.args.push(arg.expr);
        program = skipSpace(arg.rest);

        if(program[0] == ","){
          program = program.slice(1);
        }
        else if(program[0] != ")"){
          throw new SyntaxError("Expected ',' or ')'");
        }
      }
      return parseApply(expr, program.slice(1));
    }



    const specialForms = Object.create(null);

    specialForms.if = (args, scope) => {
      if(args.length != 3){
        throw new SyntaxError("Wrong number of args to if");
      }
      else if (evaluate(args[0], scope) !== false){
        return evaluate(args[1], scope);
      }
      else {
        return evaluate(args[2], scope);
      }
    };

    specialForms.while = (args, scope) => {
      if(args.length != 2){
        throw new SyntaxError("Wrong number of args to while");
      }
      while(evaluate(args[0], scope) !== false){
        evaluate(args[1], scope);
      }

      return false;
    };

    specialForms.do = (args, scope) => {
      let value = false;
      for(let arg of args){
        value = evaluate(arg, scope);
      }

      return value;
    };

    specialForms.define = (args, scope) => {

      if(args.length != 2|| args[0].type !== "word"){
        throw new SyntaxError("Incorrect use of define");
      }

      let value = evaluate(args[1], scope);
      scope[args[0].name] = value;

      return value;
    };






    function run(program){
      return evaluate(parse(program), Object.create(topScope));
    }





    function parse(program){
      let {expr, rest} = parseExpression(program);
      if(skipSpace(rest).length > 0){
        throw new SyntaxError("Unexpected text after program");
      }
      return expr;
    }

    // console.log(parse("+(a, 10)"));

    // evaluator


    function evaluate(expr, scope){
      // console.log("printing expression", expr);
      // console.log(scope, specialForms);


      if(expr.type == "value"){
        // console.log("value", expr);
        return expr.value;
      }

      else if(expr.type == "word"){
        // console.log("word", expr);

        if(expr.name in scope){
          return scope[expr.name];
        }
        else{
          throw new ReferenceError(`undefined binding: ${expr.name}`);
        }
      }

      else if(expr.type == "apply"){
        let {operator, args} = expr;
        // console.log("apply", operator, args);

        if(operator.type == "word" &&
          operator.name in specialForms){
            // console.log(operator.name, expr.args)
            return specialForms[operator.name](expr.args, scope);
        }
        else{
          let op = evaluate(operator, scope);
          if(typeof op == "function"){
            // console.log(operator,, args[1].value);

            console.log(op, op(...args.map(arg=>evaluate(arg, scope))));

            return op(...args.map(arg => evaluate(arg, scope)));
          } else {
            throw new TypeError("Applying for a non function");
          }
        }

      }
    }



    run('do(define(total, 0), define(count, 1), while(<(count, 11), do(define(total, +(total, count)), define(count, +(count, 1)))), print(total))');





    </script>
  </head>
  <body>

  </body>
</html>
